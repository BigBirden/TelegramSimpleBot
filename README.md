# Телеграм-бот "Говорилка"

Простой телеграм-бот, который предоставляет пользователям интересные факты, мудрые поговорки и анекдоты. Также включает дополнительные функции, такие как рандомизатор чисел и другие развлекательные элементы.

## Функционал

### Основные команды:
- `/start` - Запустить бота и получить приветственное сообщение
- `/help` - Показать список доступных команд
- `/base` - Проверить подключение к базе данных
- `/users` - Получить список всех пользователей из БД. Выводит ID и Имя
- `/re_chat` - Получить последние сообщения пользователя. В качестве аргумента необходимо указать ID пользователя
- `/pray` - "Помолиться" (развлекательная функция)

### Основные функции:
- **Факт** - отправляет случайный интересный факт
- **Поговорка** - отправляет мудрую цитату
- **Анекдот** - отправляет случайный анекдот
- **Каталог** - показывает дополнительные функции бота

### Дополнительные функции (в каталоге):
- **Рандомизатор** - выбирает случайное число из заданного диапазона

### Секретные функции:
- Реакция на слова "сбеу", "сбэу", "sbey", "sbeu"
- Игра в пинг-понг (ответ на "ping" или "пинг")
- Анимация с рыбкой (ответ на "fish" или "fihs")
- Реакция на сообщения, содержащие слово "помогите"

## Основные расширения

- Python 3.10+
- Aiogram 3.x (асинхронная библиотека для Telegram Bot API)
- SQLAlchemy (для работы с базой данных)
- Logging (для ведения журнала событий)
- Asyncpg (для асинхронной работы с БД)
- Alembic (для работы с миграциями БД)
- Pydantic (опционально) – валидация данных (если потребуется в будущем)
- Python-Dotenv – загрузка переменных окружения из .env

## Установка и запуск

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/ваш-username/ваш-репозиторий.git
   cd ваш-репозиторий
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Создайте файл `.env` в корне проекта и добавьте:
   ```
   BOT_TOKEN=ваш_токен_бота
   DATABASE_URL=ваш_url_базы_данных
   POSTGRES_USER=имя_пользователя
   POSTGRES_PASSWORD=пароль_пользователя
   POSTGRES_DB=имя_бд
   ```

4. Запустите бота:
   ```bash
   python app/main.py
   ```

## **Структура проекта**
```
app/
├── alembic/                  # Миграции БД
│   ├── versions/             # Файлы миграций
│   └── env.py                # Конфиг Alembic
├── data/                     # Текстовые файлы (факты, анекдоты)
├── picts/                    # Изображения для бота
├── db.py                     # Подключение к БД (асинхронное)
├── func.py                   # Логика рандомизации
├── handlers.py               # Обработчики команд бота
├── keyboards.py              # Клавиатуры
├── logger.py                 # Настройки логов
├── main.py                   # Запуск бота
└── models.py                 # Модели SQLAlchemy
```

## **Миграции базы данных (Alembic)**
Проект использует **Alembic** для управления миграциями базы данных. Все файлы, связанные с миграциями, находятся в папке `alembic/versions` (кроме alembic.ini):

1. **`env.py`**  
   Конфигурационный файл для Alembic. Содержит настройки для:  
   - Подключения к БД (использует переменную окружения `DATABASE_URL`).  
   - Указания метаданных моделей SQLAlchemy (`target_metadata = Base.metadata`).  
   - Запуска миграций в асинхронном режиме.

2. **Миграции в `alembic/versions`**  
   - `cffefecefeb9.py` — Первичная миграция, создающая таблицы:  
     ```python
     users, dialogs, dialog_users, messages
     ```  
   - `2376fa31bfbf_.py` — Тестовая миграция, добавляющая демо-данные:  
     - 3 пользователя (админ + 2 обычных).  
     - Диалог между пользователями.  
     - 6 тестовых сообщений.  

3. **`alembic.ini`**  
   Файл для Alembic с путем к скрипту и строкой подключения (устанавливается в env.py). С

---

#### **Команды для работы с миграциями**
1. **Создание новой миграции** (после изменения моделей в `models.py`):  
   ```bash
   alembic revision --autogenerate -m "Описание изменений"
   ```

2. **Применение миграций**:  
   ```bash
   alembic upgrade head
   ```

3. **Откат миграции**:  
   ```bash
   alembic downgrade -1
   ```

4. **Заполнение тестовыми данными** (из миграции `2376fa31bfbf_.py`):  
   ```bash
   alembic upgrade 2376fa31bfbf
   ```

---

#### **Как запустить проект**
1. **Настройка переменных окружения**:  
   Создайте файл `.env` в корне проекта:  
   ```ini
   DATABASE_URL=postgresql+asyncpg://user:password@localhost/dbname
   BOT_TOKEN=ваш_токен_бота
   ```

2. **Применение миграций**:  
   ```bash
   alembic upgrade head
   ```

3. **Запуск бота**:  
   ```bash
   python app/main.py
   ```

4. **Тестирование**:  
   - Проверка подключения к БД: команда `/base`.  
   - Просмотр тестовых пользователей: команда `/users`.  
   - Просмотр сообщений пользователя: `/re_chat 1` (где `1` — ID пользователя).  

---

#### **Работа в Docker**
1. **Создание контейнеров**:
   ```bash
   docker-compose up --build
   ```

2. **Для миграций**:
   Создастся 3 контейнера: для бота, для alembic и для БД.
   Для работы с миграциями подключитесь к контейнеру с alembic: 
   ```bash
   docker exec -it telegrambot-alembic-1 /bin/bash
   ```
   В нем вы можете выполнять любые команды с alembic.

3. **Проверка изменений в БД после миграций**:  
   Для работы с БД подключитесь к контейнеру с БД:
   ```bash
   docker-compose exec db psql -U postgres -d postgres
   ```
   После этого можете писать запросы на вывод и проводить проверку БД. Для выхода введите ```exit```.

4. **Тестирование внутри бота**:  
   - Проверка подключения к БД: команда `/base`.  
   - Просмотр тестовых пользователей: команда `/users`. Выводит список всех пользователей в базе в виде "ID: n, Имя: name".  
   - Просмотр сообщений пользователя: `/re_chat 1` (где `1` — ID пользователя). Выводит последние сообщения пользователя в обратном порядке отправления.

---

Файлы миграций и `env.py` обеспечивают гибкое управление схемой БД и тестовыми данными, что особенно полезно при разработке новых функций.
