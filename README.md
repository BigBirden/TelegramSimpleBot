# Телеграм-бот "Говорилка"

Простой телеграм-бот, который предоставляет пользователям интересные факты, мудрые поговорки и анекдоты. Также включает дополнительные функции, такие как рандомизатор чисел и другие развлекательные элементы. Работает асинхронно с такой же асинхронной БД.

## Функционал

### Основные команды:
- `/start` - Запустить бота и получить приветственное сообщение
- `/help` - Показать список доступных команд
- `/vk_auth` - Оправляет ссылку для авторизации через VK ID (итоговый токен сохраняется в БД в зашифрованном виде)
- `/base` - Проверить подключение к базе данных
- `/users` - Получить список всех пользователей из БД. Выводит ID и Имя
- `/re_chat` - Получить последние сообщения пользователя. В качестве аргумента необходимо указать ID пользователя
- `/pray` - "Помолиться" (развлекательная функция)

### Основные функции:
- **Факт** - отправляет случайный интересный факт
- **Поговорка** - отправляет мудрую цитату
- **Анекдот** - отправляет случайный анекдот
- **Каталог** - показывает дополнительные функции бота

### Дополнительные функции (в каталоге):
- **Рандомизатор** - выбирает случайное число из заданного диапазона

### Секретные функции:
- Реакция на слова "сбеу", "сбэу", "sbey", "sbeu"
- Игра в пинг-понг (ответ на "ping" или "пинг")
- Анимация с рыбкой (ответ на "fish" или "fihs")
- Реакция на сообщения, содержащие слово "помогите"

## Основные расширения

- Python 3.10+
- Aiogram 3.x (асинхронная библиотека для Telegram Bot API)
- SQLAlchemy (для работы с базой данных)
- Logging (для ведения журнала событий)
- Asyncpg (для асинхронной работы с БД)
- Alembic (для работы с миграциями БД)
- Pydantic (опционально) – валидация данных (если потребуется в будущем)
- Python-Dotenv – загрузка переменных окружения из .env
- FastAPI - для сервера, на котором обрабатываются запросы от VK

## Установка и запуск без Docker

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/ваш-username/ваш-репозиторий.git
   cd ваш-репозиторий
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Создайте файл `.env` в корне проекта и добавьте:
   ```
   # Настройки Telegram
   BOT_TOKEN=ваш_токен
   # Настройки PostgreSQL
   POSTGRES_USER=имя_пользователя
   POSTGRES_PASSWORD=пароль_пользователя
   POSTGRES_DB=имя_бд
   DATABASE_URL=postgresql+asyncpg://имя_пользователя:пароль_пользователя@название_контейнера:порт/имя_бд
   # Настройки VK
   VK_APP_ID=id_приложения
   VK_CALLBACK_URL=url_для_перенаправления_после_авторизации
   # Ключ шифрования
   FERNET_KEY=ключ_шифрования
   ```

   Прим.: ID для VK вы берете на странице вашего зарегистрированного приложения.
   Сгенерировать ключ можно следующим образом:
   ```bash
   python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
   ```

4. Запустите бота:
   ```bash
   python app/main.py
   ```

## **Структура проекта**
```
app/
├── alembic/                  # Миграции БД
│   ├── versions/             # Файлы миграций
│   └── env.py                # Конфиг Alembic
├── data/                     # Текстовые файлы (факты, анекдоты)
├── picts/                    # Изображения для бота
├── db.py                     # Подключение к БД (асинхронное)
├── func.py                   # Логика рандомизации
├── handlers.py               # Обработчики команд бота
├── keyboards.py              # Клавиатуры
├── logger.py                 # Настройки логов
├── main.py                   # Запуск бота
└── models.py                 # Модели SQLAlchemy
server/
├── app.py                   # Запуск сервера
└── success.html             # Страница успешной авторизации
```

## **Миграции базы данных (Alembic)**
Проект использует **Alembic** для управления миграциями базы данных. Все файлы, связанные с миграциями, находятся в папке `alembic/versions` (кроме alembic.ini):

1. **`env.py`**  
   Конфигурационный файл для Alembic. Содержит настройки для:  
   - Подключения к БД (использует переменную окружения `DATABASE_URL`).  
   - Указания метаданных моделей SQLAlchemy (`target_metadata = Base.metadata`).  
   - Запуска миграций в асинхронном режиме.

2. **Миграции в `alembic/versions`**  
   - `accf87e1222f_.py` — Первичная миграция, создающая таблицы:  
     ```python
     users, dialogs, messages
     ```  
   - `f632409af728_.py` — Вторая миграция, добавляющая таблицу:  
     ```python
     vk_tokens
     ```   

3. **`alembic.ini`**  
   Файл для Alembic с путем к скрипту и строкой подключения (устанавливается в env.py).

---

#### **Команды для работы с миграциями**
1. **Создание новой миграции** (после изменения моделей в `models.py`):  
   ```bash
   alembic revision --autogenerate -m "Описание изменений"
   ```

2. **Применение миграций**:  
   ```bash
   alembic upgrade head
   ```

3. **Откат миграции**:  
   ```bash
   alembic downgrade -1
   ```
   
#### **Работа в Docker**
Данный способ является предпочтительным
1. **Создание контейнеров**:
   ```bash
   docker-compose up --build
   ```

2. **Для миграций**:
   Создадутся 4 контейнера: для бота, для alembic, для сервера и для основной БД Postgre.
   Для работы с миграциями подключитесь к контейнеру с alembic: 
   ```bash
   docker exec -it telegrambot-alembic-1 /bin/bash
   ```
   В нем вы можете выполнять любые команды с alembic.

3. **Проверка изменений в БД после миграций**:  
   Для работы с БД подключитесь к контейнеру с БД:
   ```bash
   docker-compose exec db psql -U postgres -d postgres
   ```
   После этого можете писать запросы на вывод и проводить проверку БД. Для выхода введите ```exit```.

4. **Тестирование внутри бота**:  
   - Проверка подключения к БД: команда `/base`.  
   - Просмотр тестовых пользователей: команда `/users`. Выводит список всех пользователей в базе в виде "ID: n, Имя: name".  
   - Просмотр сообщений пользователя: `/re_chat 1` (где `1` — ID пользователя). Выводит последние сообщения пользователя в обратном порядке отправления.

#### **Работа с VK API**
   После создания контейнеров используйте в боте команду:
   ```
   /vk_auth
   ```
   Вам сгенерирует ссылку для авторизации - перейдите по ней. 
   На открывшейся странице в браузере нажмите "Разрешить".
   При успешной авторизации вам откроется страница "Авторизация успешна".

   Генерируется ссылка, направляющая на сервер. На сервере создается ссылка на авторизацию, по которой потом получается код.
   Код обменивается на токен и записывается в бд для текущего тг-пользователя.

   Прим.: При повторной авторизации токен будет перезаписан в БД.

---

Файлы миграций и `env.py` обеспечивают гибкое управление схемой БД и тестовыми данными, что особенно полезно при разработке новых функций.
